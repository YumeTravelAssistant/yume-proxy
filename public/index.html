<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YUTA Travel Assistant</title>
  <!-- Favicons -->
   <link rel="icon" type="image/x-icon" href="favicon.ico">
   <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
   <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">

</head>
<body>

  <header>
    <img src="assets/logo-yuta.jpg" alt="Logo YUTA">
    <h1>YUTA - il tuo assistente di viaggio</h1>
    <div class="slogan">Accessibile. Autentico. Per te.</div>
  </header>
  <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>

  <div id="sidebar" class="sidebar">
    <a href="home.html">Home</a>
    <a href="index.html">YUTA</a>
    <a href="yuta.html">Cos'√® YUTA</a>
    <a href="chi-siamo.html">Chi siamo</a>
    <a href="contatti.html">Contatti</a>
    <a href="faq.html">FAQ</a>
  <a href="profilo.html">Registrazione</a>
  <a href="log-in.html">Area Personale</a>
    </div>

  <main>
    <label for="clienteId">Codice Cliente:</label>
    <input type="text" id="clienteId" placeholder="Es: YUME123" />

    <label for="domanda">Domanda:</label>
    <textarea id="domanda" rows="4" placeholder="Es: Quando ho il check-in a Kyoto?"></textarea>

    <button onclick="inviaDomanda()">Invia</button>

    <div class="output" id="risposta"></div>
    <div id="spinner" class="spinner" style="display:none;"></div>

    <div id="luoghi-trovati" style="display:none; margin-top: 20px; font-size: 1em; color: #1C1C1C;"></div>

    <button onclick="toggleMeteo()" id="toggleMeteoBtn" style="display: none; margin-top: 10px;"> üìç Mostra meteo</button>

    <div id="meteoBox" style="display: none; margin-top: 10px; font-size: 1em; color: #1c1c1c;"></div>

    <button id="toggleMappaBtn" onclick="toggleMappa()" style="display:none; margin-top: 10px;">üìç Mostra mappa</button>

    <div id="map" style="height: 400px; margin-top: 20px; border-radius: 12px; display: none;"></div>

    <button id="nuovaDomandaBtn" style="display:none; margin-top:20px;" onclick="nuovaDomanda()">‚ûï Nuova domanda</button>
  </main>

  <footer>
    YUTA √® un software registrato di Yume Travel Tech.
  </footer>

<script>
  const textarea = document.getElementById("domanda");
  textarea.addEventListener("keydown", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      inviaDomanda();
  }
  });

function rilevaDataFutura(domanda) {
  const mesi = {
    gennaio: 0, febbraio: 1, marzo: 2, aprile: 3, maggio: 4, giugno: 5,
    luglio: 6, agosto: 7, settembre: 8, ottobre: 9, novembre: 10, dicembre: 11
  };

  const regex = /\b(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)\b/i;
  const match = domanda.toLowerCase().match(regex);

  if (match) {
    const giorno = parseInt(match[1], 10);
    const mese = mesi[match[2]];
    const oggi = new Date();
    const anno = oggi.getMonth() > mese ? oggi.getFullYear() + 1 : oggi.getFullYear();

    const dataRichiesta = new Date(anno, mese, giorno);
    const diffInGiorni = Math.floor((dataRichiesta - oggi) / (1000 * 60 * 60 * 24));

    return diffInGiorni;
  }

  return null;
}

function nuovaDomanda() {
  document.getElementById("domanda").value = "";
  document.getElementById("risposta").innerHTML = "";
  document.getElementById("luoghi-trovati").style.display = "none";
  document.getElementById("toggleMappaBtn").style.display = "none";
  document.getElementById("map").style.display = "none";
  document.getElementById("nuovaDomandaBtn").style.display = "none";

   // Rimuove tutti i marker dalla mappa e svuota l‚Äôarray
   markers.forEach(m => m.setMap(null));
   markers = [];

// ‚úÖ Resetta meteo
window.fraseMeteoUtente = "";
document.getElementById("toggleMeteoBtn").style.display = "none";
document.getElementById("meteoBox").style.display = "none";

}

const cittaGiappone = {
  tokyo: { nome: "Tokyo", lat: 35.6764, lon: 139.6500 },
  kyoto: { nome: "Kyoto", lat: 35.0116, lon: 135.7681 },
  osaka: { nome: "Osaka", lat: 34.6937, lon: 135.5023 },
  nara: { nome: "Nara", lat: 34.6851, lon: 135.8048 },
  yokohama: { nome: "Yokohama", lat: 35.4437, lon: 139.6380 },
  sapporo: { nome: "Sapporo", lat: 43.0667, lon: 141.3500 },
  fukuoka: { nome: "Fukuoka", lat: 33.5902, lon: 130.4017 },
  nagoya: { nome: "Nagoya", lat: 35.1815, lon: 136.9066 },
  hiroshima: { nome: "Hiroshima", lat: 34.3853, lon: 132.4553 },
  kobe: { nome: "Kobe", lat: 34.6901, lon: 135.1955 },
  kawasaki: { nome: "Kawasaki", lat: 35.5308, lon: 139.7036 },
  saitama: { nome: "Saitama", lat: 35.8617, lon: 139.6455 },
  sendai: { nome: "Sendai", lat: 38.2682, lon: 140.8694 },
  chiba: { nome: "Chiba", lat: 35.6074, lon: 140.1065 },
  kumamoto: { nome: "Kumamoto", lat: 32.7898, lon: 130.7417 },
  kagoshima: { nome: "Kagoshima", lat: 31.5966, lon: 130.5571 },
  nagasaki: { nome: "Nagasaki", lat: 32.7503, lon: 129.8777 },
  matsuyama: { nome: "Matsuyama", lat: 33.8392, lon: 132.7657 },
  oita: { nome: "Oita", lat: 33.2396, lon: 131.6093 },
  takamatsu: { nome: "Takamatsu", lat: 34.3401, lon: 134.0434 },
  kanazawa: { nome: "Kanazawa", lat: 36.5613, lon: 136.6562 },
  toyama: { nome: "Toyama", lat: 36.6953, lon: 137.2113 },
  niigata: { nome: "Niigata", lat: 37.9161, lon: 139.0364 },
  akita: { nome: "Akita", lat: 39.7200, lon: 140.1025 },
  aomori: { nome: "Aomori", lat: 40.8244, lon: 140.7400 },
  iwaki: { nome: "Iwaki", lat: 37.0500, lon: 140.8833 },
  hakodate: { nome: "Hakodate", lat: 41.7688, lon: 140.7288 },
  asahikawa: { nome: "Asahikawa", lat: 43.7706, lon: 142.3649 },
  takayama: { nome: "Takayama", lat: 36.1466, lon: 137.2510 },
  gifu: { nome: "Gifu", lat: 35.4233, lon: 136.7606 },
  nagano: { nome: "Nagano", lat: 36.6486, lon: 138.1947 },
  ueda: { nome: "Ueda", lat: 36.4023, lon: 138.2507 },
  shizuoka: { nome: "Shizuoka", lat: 34.9756, lon: 138.3828 },
  hamamatsu: { nome: "Hamamatsu", lat: 34.7100, lon: 137.7261 },
  hachinohe: { nome: "Hachinohe", lat: 40.5122, lon: 141.4880 },
  kure: { nome: "Kure", lat: 34.2331, lon: 132.5667 },
  tsu: { nome: "Tsu", lat: 34.7303, lon: 136.5086 },
  yokkaichi: { nome: "Yokkaichi", lat: 34.9653, lon: 136.6247 },
  beppu: { nome: "Beppu", lat: 33.2792, lon: 131.4970 },
  hikone: { nome: "Hikone", lat: 35.2764, lon: 136.2515 }
};

function trovaCittaNellaDomanda(domanda) {
  const testo = domanda.toLowerCase();
  for (const nome in cittaGiappone) {
    if (testo.includes(nome)) {
      return cittaGiappone[nome]; // restituisce { lat, lon, nome }
    }
  }
  return null;
}

  async function inviaDomanda() {
    const clienteId = document.getElementById("clienteId").value.trim();
    const domanda = document.getElementById("domanda").value.trim();

const oraLocale = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });

const citt√†Richiesta = trovaCittaNellaDomanda(domanda);
const posizioneMeteo = citt√†Richiesta || posizioneUtente;

if (!window.fraseMeteoUtente) window.fraseMeteoUtente = "";

const giorniDifferenza = rilevaDataFutura(domanda);

if (giorniDifferenza !== null && giorniDifferenza > 7) {
  window.fraseMeteoUtente = "‚ö†Ô∏è Hai chiesto il meteo per una data futura. Al momento posso fornire previsioni solo entro i prossimi 7 giorni.";
}

if (citt√†Richiesta === null && domanda.toLowerCase().includes("meteo")) {
  window.fraseMeteoUtente = "‚ö†Ô∏è La funzione Meteo al momento non copre questa localit√†.";
}

if (posizioneMeteo && posizioneMeteo.lat && posizioneMeteo.lon) {
  await ottieniMeteo(posizioneMeteo.lat, posizioneMeteo.lon);
}

    const rispostaEl = document.getElementById("risposta");
    attivaGooglePlacesDaDomanda(domanda);
    attivaAttrazioniDaDomanda(domanda);
    rispostaEl.innerHTML = "";
    
if (window.fraseMeteoUtente && window.fraseMeteoUtente.trim() !== "") {
  document.getElementById("toggleMeteoBtn").style.display = "inline-block";
} else {
  document.getElementById("toggleMeteoBtn").style.display = "none";
  document.getElementById("meteoBox").style.display = "none";
}

    document.getElementById("spinner").style.display = "block";
    document.getElementById("nuovaDomandaBtn").style.display = "inline-block";

   try{

    document.getElementById("nuovaDomandaBtn").style.display = "none"; // nasconde il bottone in partenza

console.log("üì¶ METEO inviato:", window.fraseMeteoUtente);
console.log("üì¶ ORA locale:", oraLocale);
console.log("üì¶ Previsioni 7 giorni:", window.previsioniMeteoGiorni);

const fraseMeteoFinale = typeof window.fraseMeteoUtente === "string" ? window.fraseMeteoUtente : "";
const previsioniGiorniFinali = Array.isArray(window.previsioniMeteoGiorni) ? window.previsioniMeteoGiorni : [];

console.log("üõ∞Ô∏è METEO da inviare:", fraseMeteoFinale);
console.log("üõ∞Ô∏è PREVISIONI da inviare:", previsioniGiorniFinali);

// ‚¨áÔ∏è Questi valori vengono passati nel payload
const datiMeteoAttuale = fraseMeteoFinale;
const datiPrevisioni = previsioniGiorniFinali;

console.log("üì§ Sto per inviare:");
console.log("üõ∞Ô∏è METEO:", datiMeteoAttuale);
console.log("üõ∞Ô∏è PREVISIONI:", datiPrevisioni);

console.log("‚úÖ Tipo previsioniGiorniFinali:", typeof previsioniGiorniFinali);
console.log("‚úÖ √à array?:", Array.isArray(previsioniGiorniFinali));
console.log("‚úÖ Contenuto previsioni:", JSON.stringify(previsioniGiorniFinali));


    const response = await fetch("https://yuta-proxy-api.azurewebsites.net/api/proxy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
       clienteId,
       domanda,
       meteo: fraseMeteoFinale,
       oraLocale,
       previsioniGiorni: previsioniGiorniFinali 
      })
    });

let json;
try {
  json = await response.json();
} catch (e) {
  rispostaEl.textContent = "‚ùå Il server ha restituito una risposta non valida.";
  document.getElementById("spinner").style.display = "none";
  console.error("Errore parse JSON:", e);
  return;
}
    if (json.risposta) {
//   Rimuove eventuali marker precedenti prima di creare i nuovi
markers.forEach(m => m.setMap(null));
markers = [];

      let testo = json.risposta
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\n### (.*?)\n/g, "<h3>$1</h3>")
        .replace(/\n- (.*?)\n/g, "<ul><li>$1</li></ul>")
        .replace(/(?:\r\n|\r|\n)/g, "<br>");
      testo = testo.replace(/<\/ul><ul>/g, "");


let trovatoLuogo = false;
const luoghiTrovati = [];

for (const nome in luoghiConosciuti) {
  const regex = new RegExp(nome, "i");
  if (regex.test(json.risposta)) {
    trovatoLuogo = true;
    luoghiTrovati.push({ nome, ...luoghiConosciuti[nome] });
  }
}
      rispostaEl.innerHTML = "";
      let i = 0;
      let testoGrezzato = testo.replace(/<[^>]*>?/gm, ""); // Rimuove tag HTML solo per animazione

      function typeChar() {
        if (i < testoGrezzato.length) {
          rispostaEl.textContent += testoGrezzato.charAt(i);
          i++;
          setTimeout(typeChar, 20); // pi√π lento, circa 3x pi√π umano
        } else {
          rispostaEl.innerHTML = testo; // mostra versione HTML completa e stilizzata
          document.getElementById("spinner").style.display = "none";
          document.getElementById("nuovaDomandaBtn").style.display = "inline-block";

// ‚úÖ Mostra lista testuale dei luoghi trovati
if (trovatoLuogo && posizioneUtente) {
  const divLuoghi = document.getElementById("luoghi-trovati");
  const lista = luoghiTrovati.map(p => {
    const distanza = calcolaDistanzaKm(posizioneUtente, { lat: p.lat, lng: p.lng });
    return `‚Ä¢ ${p.nome} (a ${distanza} km da te)`;
  }).join("<br>");
  divLuoghi.innerHTML = `<strong>üìç Luoghi rilevati:</strong><br>${lista}`;
  divLuoghi.style.display = "block";

// ‚úÖ Mostra il pulsante "Mostra mappa"
      document.getElementById("toggleMappaBtn").style.display = "inline-block";
    } else {
      document.getElementById("luoghi-trovati").style.display = "none";
      document.getElementById("toggleMappaBtn").style.display = "none";
    }


  // ‚úÖ Mostra i luoghi trovati, se presenti
if (trovatoLuogo && map && posizioneUtente) {
  luoghiTrovati.forEach((p) => {
    const distanza = calcolaDistanzaKm(posizioneUtente, { lat: p.lat, lng: p.lng });

    const marker = new google.maps.Marker({
      position: { lat: p.lat, lng: p.lng },
      map: map,
      title: `${p.nome} (a ${distanza} km da te)`
    });

    marker.addListener("click", () => {
      window.open(p.link, "_blank");
    });
     markers.push(marker);
  });
document.getElementById("map").style.display = "none";

}
        }
      }
      typeChar();
     } else {
       rispostaEl.textContent = "‚ùå Nessuna risposta ricevuta.";
     } 
    } catch (err) {
      rispostaEl.textContent = "‚ùå Errore durante la richiesta.";
      console.error("Errore:", err);
    }
  }
</script>

<script>
let map;
let posizioneUtente = null;
let markers = []; // array per tenere traccia dei marker attivi

async function ottieniMeteo(lat, lon) {
  const apiKey = "7b514410b5b297ed1e5590442ff67eca"; // tua API key attiva
  const url = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=minutely,alerts&appid=${apiKey}&lang=it&units=metric`;

  try {
    const response = await fetch(url);
    const json = await response.json();

window.previsioniMeteoGiorni = [];

if (json.daily && Array.isArray(json.daily)) {
  json.daily.slice(0, 7).forEach((giorno, index) => {
    const data = new Date(giorno.dt * 1000).toLocaleDateString("it-IT", { weekday: 'long', day: 'numeric', month: 'long' });
    const descrizione = giorno.weather[0].description;
    const tempMin = Math.round(giorno.temp.min);
    const tempMax = Math.round(giorno.temp.max);
    const pioggia = Math.round((giorno.pop || 0) * 100);

    const frase = `üìÖ ${data}: ${descrizione}, min ${tempMin}¬∞C / max ${tempMax}¬∞C, probabilit√† di pioggia ${pioggia}%.`;

    window.previsioniMeteoGiorni.push(frase);
  });
}

    const condizioneAttuale = json.current.weather[0].description;
    const temperatura = Math.round(json.current.temp);
    const pioveOra = condizioneAttuale.includes("pioggia");

    // Analizza se piover√† nelle prossime 8 ore
    const previsionePioggia = json.hourly.slice(0, 8).some(hour => {
      return hour.weather[0].description.includes("pioggia") || (hour.pop && hour.pop > 0.4);
    });

    let frase = `‚òÅÔ∏è Meteo attuale: ${condizioneAttuale}, ${temperatura}¬∞C.`;

    if (pioveOra || previsionePioggia) {
      frase += " √à prevista pioggia nelle prossime ore. Si consigliano attivit√† al chiuso, percorsi coperti e abbigliamento impermeabile.";
    } else {
      frase += " Nessuna pioggia prevista fino al tardo pomeriggio.";
    }

    window.fraseMeteoUtente = frase;
  } catch (err) {
    console.error("üåßÔ∏è Errore One Call API:", err);
    window.fraseMeteoUtente = "";
  }
}

const luoghiConosciuti = {
  "Senso-ji": { lat: 35.7148, lng: 139.7967, link: "https://www.google.com/maps?q=Senso-ji,Tokyo" },
  "Meiji Jingu": { lat: 35.6764, lng: 139.6993, link: "https://www.google.com/maps?q=Meiji+Jingu" },
  "Tokyo Tower": { lat: 35.6586, lng: 139.7454, link: "https://www.google.com/maps?q=Tokyo+Tower" },
  "Tokyo Skytree": { lat: 35.7101, lng: 139.8107, link: "https://www.google.com/maps?q=Tokyo+Skytree" },
  "Shibuya Crossing": { lat: 35.6595, lng: 139.7005, link: "https://www.google.com/maps?q=Shibuya+Crossing" },
  "Asakusa": { lat: 35.7148, lng: 139.7967, link: "https://www.google.com/maps?q=Asakusa,Tokyo" },
  "Ueno Zoo": { lat: 35.7166, lng: 139.7710, link: "https://www.google.com/maps?q=Ueno+Zoo" },
  "Ueno Park": { lat: 35.7148, lng: 139.7736, link: "https://www.google.com/maps?q=Ueno+Park" },
  "Akihabara": { lat: 35.6984, lng: 139.7730, link: "https://www.google.com/maps?q=Akihabara" },
  "Ginza": { lat: 35.6717, lng: 139.7650, link: "https://www.google.com/maps?q=Ginza" },
  "Tsukiji Market": { lat: 35.6655, lng: 139.7708, link: "https://www.google.com/maps?q=Tsukiji+Market" },
  "TeamLab Planets": { lat: 35.6199, lng: 139.7906, link: "https://www.google.com/maps?q=teamlab+planets+tokyo" },
  "Tokyo Disneyland": { lat: 35.6329, lng: 139.8804, link: "https://www.google.com/maps?q=Tokyo+Disneyland" },
  "Tokyo DisneySea": { lat: 35.6263, lng: 139.8889, link: "https://www.google.com/maps?q=Tokyo+DisneySea" },
  "Roppongi Hills": { lat: 35.6605, lng: 139.7292, link: "https://www.google.com/maps?q=Roppongi+Hills" },
  "Mori Art Museum": { lat: 35.6606, lng: 139.7294, link: "https://www.google.com/maps?q=Mori+Art+Museum" },
  "Odaiba": { lat: 35.6273, lng: 139.7758, link: "https://www.google.com/maps?q=Odaiba" },
  "DiverCity Tokyo": { lat: 35.6191, lng: 139.7761, link: "https://www.google.com/maps?q=DiverCity+Tokyo" },
  "Rainbow Bridge": { lat: 35.6457, lng: 139.7574, link: "https://www.google.com/maps?q=Rainbow+Bridge+Tokyo" },
  "Sumida Aquarium": { lat: 35.7102, lng: 139.8107, link: "https://www.google.com/maps?q=Sumida+Aquarium" },
  "Tokyo National Museum": { lat: 35.7188, lng: 139.7765, link: "https://www.google.com/maps?q=Tokyo+National+Museum" },
  "Nezu Museum": { lat: 35.6593, lng: 139.7221, link: "https://www.google.com/maps?q=Nezu+Museum" },
  "Yanaka Ginza": { lat: 35.7275, lng: 139.7654, link: "https://www.google.com/maps?q=Yanaka+Ginza" },
  "Imperial Palace": { lat: 35.6852, lng: 139.7528, link: "https://www.google.com/maps?q=Imperial+Palace+Tokyo" },
  "Kabukicho": { lat: 35.6959, lng: 139.7036, link: "https://www.google.com/maps?q=Kabukicho" },
  "Tokyo Dome": { lat: 35.7056, lng: 139.7519, link: "https://www.google.com/maps?q=Tokyo+Dome" },
  "Ikebukuro Sunshine City": { lat: 35.7295, lng: 139.7179, link: "https://www.google.com/maps?q=Sunshine+City+Ikebukuro" },
  "Shinjuku Gyoen": { lat: 35.6852, lng: 139.7100, link: "https://www.google.com/maps?q=Shinjuku+Gyoen" },
  "Tokyo Metropolitan Government Building": { lat: 35.6896, lng: 139.6921, link: "https://www.google.com/maps?q=Tokyo+Metropolitan+Government+Building" },
  "Hamarikyu Gardens": { lat: 35.6591, lng: 139.7625, link: "https://www.google.com/maps?q=Hamarikyu+Gardens" }
};

function calcolaDistanzaKm(p1, p2) {
  const R = 6371; // Raggio terrestre in km
  const dLat = (p2.lat - p1.lat) * Math.PI / 180;
  const dLon = (p2.lng - p1.lng) * Math.PI / 180;
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return (R * c).toFixed(2); // distanza in km con 2 decimali
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 13,
    center: { lat: 35.6895, lng: 139.6917 }, // Tokyo default
    mapTypeControl: false
  });

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        posizioneUtente = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        map.setCenter(posizioneUtente);

        new google.maps.Marker({
          position: posizioneUtente,
          map,
          title: "Tu sei qui",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#1c1c1c",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "#ffffff"
          }
        });

// document.getElementById("map").style.display = "block"; // sar√† gestita manualmente dal pulsante
      },
      (error) => {
        console.warn("‚ùå Geolocalizzazione non disponibile:", error);
      }
    );
  } else {
    console.warn("‚ùå Geolocalizzazione non supportata");
  }
}

function estraiKeywordLuogo(domanda) {
  const paroleChiave = ["ramen", "sushi", "vegano", "izakaya", "tempura", "okonomiyaki"];
  const testo = domanda.toLowerCase();
  return paroleChiave.find(p => testo.includes(p)) || ""; // se nulla, restituisce stringa vuota
}

function cercaLuoghiPerZona(domanda, tipo = "restaurant", keyword = "") {
  const posizione = trovaCittaNellaDomanda(domanda);

  if (!posizione || !map) {
    console.warn("‚ùå Nessuna citt√† trovata per la ricerca Places.");
    return;
  }

  const location = {
    lat: posizione.lat,
    lng: posizione.lon
  };

  const service = new google.maps.places.PlacesService(map);
  const request = {
    location: location,
    radius: 2000, // puoi regolare in base al tipo: 1500 per ristoranti, 3000 per attrazioni
    type: [tipo],
    keyword: keyword
  };

  service.nearbySearch(request, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
      console.log(`‚úÖ ${results.length} luoghi trovati a ${posizione.nome}`);
      mostraLuoghi(results, tipo);
    } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
      console.warn(`‚ö†Ô∏è Nessun luogo trovato a ${posizione.nome}`);
      document.getElementById("luoghi-trovati").innerHTML = `Nessun risultato trovato per questa zona.`;
    } else {
      console.error("‚ùå Errore Places API:", status);
    }
  });
}

function cercaLuoghiSmart(domanda, tipo = "restaurant", keyword = "") {
  const testo = domanda.toLowerCase();
  const posizioneRilevata = trovaCittaNellaDomanda(domanda);

  // ‚úÖ Regex avanzata per prossimit√† (include varianti e forme comuni)
  const regexProssimita = /\b(vicin[oa]?(?:\s*a?\s*me)?|nei\s*dintorni|qui\s*vicino|a\s*pochi\s*pass[iy]?|nelle\s+vicinanze|intorno\s*a\s*me|attorno\s*a\s*me|prossimit√†|zona\s*mia|da\s*qui|dove\s*sono|a\s*due\s*passi|immediate\s+vicinanze)\b/i;

  // ‚úÖ Parole simili come fallback in caso di digitazioni errate
  const paroleSimiliProssimita = [
    "vicin", "dintorn", "pochi pass", "intorn", "qui", "attorn", "vicinanz", "zona mia", "da qui", "dove son"
  ];

  const eVicinoAme = regexProssimita.test(testo) || paroleSimiliProssimita.some(p => testo.includes(p));

  // üìç Decidi quale posizione usare: citt√† menzionata o posizione utente
  const location = posizioneRilevata
    ? { lat: posizioneRilevata.lat, lng: posizioneRilevata.lon }
    : (eVicinoAme && posizioneUtente)
      ? posizioneUtente
      : null;

  if (!location || !map) {
    console.warn("‚ùå Nessuna posizione valida per la ricerca smart.");
    return;
  }

  const service = new google.maps.places.PlacesService(map);
  const request = {
    location: location,
    radius: 1500,
    type: [tipo],
    keyword: keyword
  };

  service.nearbySearch(request, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      mostraLuoghi(results, tipo);
    } else {
      console.error("‚ùå Errore Places smart:", status);
    }
  });
}

function attivaGooglePlacesDaDomanda(domanda) {
  const testo = domanda.toLowerCase();

  const regexCibo = /\b(mangiare|dove\s+mangiare|ristorant[ei]|izakaya|un\s+posto\s+(dove\s+)?mangiare|mi\s+consigli\s+un\s+ristorante|posto\s+per\s+pranzare|cena\s+fuori|cibo\s+tipico|locale\s+dove\s+mangiare)\b/i;

  const paroleSimiliCibo = ["ristoran", "mangiar", "mangare", "izak", "pranzar", "cenar", "cib", "lokale", "magiare", "restorant"];

  const eDomandaCibo = regexCibo.test(testo) || paroleSimiliCibo.some(p => testo.includes(p));

  if (eDomandaCibo) {
    const keyword = estraiKeywordLuogo(domanda);
    cercaLuoghiSmart(domanda, "restaurant", keyword);
  }
}

function attivaAttrazioniDaDomanda(domanda) {
  const testo = domanda.toLowerCase();

  // ‚úÖ Regex principale
  const regexAttrazioni = /\b(cosa\s+(vedere|fare|visitare)|luoghi\s+di\s+interesse|attrazioni|posti\s+da\s+vedere|cosa\s+c'√®\s+da\s+vedere|esperienze\s+turistiche|tour|da\s+visitare|luogo\s+interessante|luoghi\s+turistici|posti\s+interessanti)\b/i;

  // ‚úÖ Fallback parole chiave fuzzy o generiche
  const paroleSimiliAttrazioni = [
    "veder", "visitar", "attrazion", "interess", "esperienz", "turist", "tour", "posti", "scoprire", "cosa da vedere", "luoghi carini", "da esplorare"
  ];

  const eDomandaAttrazioni = regexAttrazioni.test(testo) || paroleSimiliAttrazioni.some(p => testo.includes(p));

  if (eDomandaAttrazioni) {
    cercaLuoghiSmart(domanda, "tourist_attraction", "");
  }
}

function mostraLuoghi(results, tipo = "luogo") {
  const div = document.getElementById("luoghi-trovati");
  let contenuto = `<strong>üîç ${tipo === "restaurant" ? "Ristoranti consigliati" : "Luoghi da visitare"}:</strong><br><br>`;

  // Pulisce marker precedenti
  markers.forEach(m => m.setMap(null));
  markers = [];

  results.slice(0, 4).forEach(place => {
    const posizione = place.geometry.location;
    const nome = place.name;
    const rating = place.rating ? `‚≠ê ${place.rating}` : "‚Äî";
    const indirizzo = place.vicinity || "Indirizzo non disponibile";
    const categoria = tipo === "restaurant" ? "Ristorante" : "Attrazione";
    const aperto = place.opening_hours?.open_now !== undefined
      ? (place.opening_hours.open_now ? "üü¢ Aperto ora" : "üî¥ Chiuso ora")
      : "Orari non disponibili";

    let distanzaTesto = "";
    if (posizioneUtente) {
      const distanzaKm = calcolaDistanzaKm(posizioneUtente, { lat: posizione.lat(), lng: posizione.lng() });
      distanzaTesto = `üß≠ ${distanzaKm} km da te<br>`;
    }

    contenuto += `
      <div style="margin-bottom: 12px;">
        <strong>${nome}</strong><br>
        ${categoria} ¬∑ ${rating}<br>
        ${aperto}<br>
        ${distanzaTesto}${indirizzo}<br>
        <hr>
      </div>
    `;

    const marker = new google.maps.Marker({
      position: posizione,
      map: map,
      title: nome
    });

    marker.addListener("click", () => {
      window.open(`https://www.google.com/maps/search/?api=1&query_place_id=${place.place_id}`, "_blank");
    });

    markers.push(marker);
  });

  div.innerHTML = contenuto;
  div.style.display = "block";
  document.getElementById("map").style.display = "block";
  document.getElementById("toggleMappaBtn").textContent = "üîΩ Nascondi mappa";
}

</script>


<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const hamburger = document.querySelector(".hamburger");
    sidebar.style.width = "250px";
    hamburger.style.display = "none";

    // Chiude sidebar al click esterno
    document.addEventListener("click", function handleClickOutside(event) {
      if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
        sidebar.style.width = "0";
        hamburger.style.display = "block";
        document.removeEventListener("click", handleClickOutside);
      }
    });
  }
</script>

<script>
function toggleMeteo() {
  const meteoDiv = document.getElementById("meteoBox");
  const btn = document.getElementById("toggleMeteoBtn");

  if (meteoDiv.style.display === "none") {
    meteoDiv.innerHTML = window.fraseMeteoUtente || "Nessuna informazione meteo disponibile.";
    meteoDiv.style.display = "block";
    btn.textContent = "üîΩ Nascondi meteo";
  } else {
    meteoDiv.style.display = "none";
    btn.textContent = "üìç Mostra meteo";
  }
}
</script>

<script>
function toggleMappa() {
  const mapEl = document.getElementById("map");
  const btn = document.getElementById("toggleMappaBtn");

  if (mapEl.style.display === "none") {
    mapEl.style.display = "block";
    btn.textContent = "üîΩ Nascondi mappa";
  } else {
    mapEl.style.display = "none";
    btn.textContent = "üìç Mostra mappa";
  }
}
</script>


<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAG11Uloyz4kU6doqFu1WHkg3HhIWH8L8&callback=initMap"
  async defer>
</script>


</body>
</html>

