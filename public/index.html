<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YUTA Travel Assistant</title>
  <!-- Favicons -->
   <link rel="icon" type="image/x-icon" href="favicon.ico">
   <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
   <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">

  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/styles.css">

</head>
<body>


  <header>
    <img src="assets/logo-yuta.jpg" alt="Logo YUTA">
    <h1>YUTA - il tuo assistente di viaggio</h1>
    <div class="slogan">Accessibile. Autentico. Per te.</div>
  </header>
  <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>

  <div id="sidebar" class="sidebar">
    <a href="home.html">Home</a>
    <a href="index.html">YUTA</a>
    <a href="yuta.html">Cos'√® YUTA</a>
    <a href="chi-siamo.html">Chi siamo</a>
    <a href="contatti.html">Contatti</a>
    <a href="faq.html">FAQ</a>
  <a href="profilo.html">Registrazione</a>
  <a href="log-in.html">Area Personale</a>
    </div>

  <main>
    <label for="clienteId">Codice Cliente:</label>
    <input type="text" id="clienteId" placeholder="Es: YUME123" />

    <label for="domanda">Domanda:</label>
    <textarea id="domanda" rows="4" placeholder="Es: Quando ho il check-in a Kyoto?"></textarea>

    <button onclick="inviaDomanda()">Invia</button>

<hr style="margin: 30px 0;">
<h3>üì∏ Analizza un'immagine</h3>
<div style="margin-top: 10px;">
  <label for="tipoAnalisi" style="display:block; margin-bottom: 6px;">Tipo di analisi:</label>
  <select id="tipoAnalisi" style="margin-bottom: 10px;">
    <option value="LABEL_DETECTION">üè∑Ô∏è Etichette (default)</option>
    <option value="TEXT_DETECTION">üî§ Testo semplice</option>
    <option value="DOCUMENT_TEXT_DETECTION">üìÑ Documento strutturato</option>
    <option value="OBJECT_LOCALIZATION">üß≠ Oggetti</option>
    <option value="FACE_DETECTION">üòä Volti</option>
    <option value="LANDMARK_DETECTION">üèØ Luoghi famosi</option>
    <option value="LOGO_DETECTION">üíº Loghi di brand</option>
  </select><br>

  <button onclick="document.getElementById('imageInput').click()">üì∑ Carica immagine</button>
  <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="analizzaImmagine()" />
  <img id="previewImg" style="margin-top: 10px; max-width: 300px; display:none; border-radius:8px;" />
<button id="resetButton" class="hidden" onclick="resetAnalisiImmagine()">üîÑ Nuova immagine</button>

</div>

<!-- Blocco per risultato simboli riconosciuti -->
<div id="risultatoVision" style="margin-top: 15px; padding: 12px; border: 1px solid #ccc; background: #f9f9f9; border-radius: 8px; color: #1C1C1C;"></div>

<!-- Blocco separato per interpretazione GPT -->
<div id="interpretazioneVision" style="margin-top: 20px;"></div>


    <div class="output" id="risposta"></div>
    <div id="spinner" class="spinner" style="display:none;"></div>

    <div id="luoghi-trovati" style="display:none; margin-top: 20px; font-size: 1em; color: #1C1C1C;"></div>

    <button onclick="toggleMeteo()" id="toggleMeteoBtn" style="display: none; margin-top: 10px;"> üìç Mostra meteo</button>

    <div id="meteoBox" style="display: none; margin-top: 10px; font-size: 1em; color: #1c1c1c;"></div>

    <button id="toggleMappaBtn" onclick="toggleMappa()" style="display:none; margin-top: 10px;">üìç Mostra mappa</button>

    <div id="map" style="height: 400px; margin-top: 20px; border-radius: 12px; display: none;"></div>

    <button id="nuovaDomandaBtn" style="display:none; margin-top:20px;" onclick="nuovaDomanda()">‚ûï Nuova domanda</button>
  </main>

  <footer>
    YUTA √® un software registrato di Yume Travel Tech.
  </footer>

<script>
  const textarea = document.getElementById("domanda");
  textarea.addEventListener("keydown", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      inviaDomanda();
  }
  });

function rilevaDataFutura(domanda) {
  const mesi = {
    gennaio: 0, febbraio: 1, marzo: 2, aprile: 3, maggio: 4, giugno: 5,
    luglio: 6, agosto: 7, settembre: 8, ottobre: 9, novembre: 10, dicembre: 11
  };

  const regex = /\b(\d{1,2})\s+(gennaio|febbraio|marzo|aprile|maggio|giugno|luglio|agosto|settembre|ottobre|novembre|dicembre)\b/i;
  const match = domanda.toLowerCase().match(regex);

  if (match) {
    const giorno = parseInt(match[1], 10);
    const mese = mesi[match[2]];
    const oggi = new Date();
    const anno = oggi.getMonth() > mese ? oggi.getFullYear() + 1 : oggi.getFullYear();

    const dataRichiesta = new Date(anno, mese, giorno);
    const diffInGiorni = Math.floor((dataRichiesta - oggi) / (1000 * 60 * 60 * 24));

    return diffInGiorni;
  }

  return null;
}

function nuovaDomanda() {
  // üîÅ Resetta input e risposta GPT
  document.getElementById("domanda").value = "";
  document.getElementById("risposta").innerHTML = "";

  // üîÅ Resetta meteo
  window.fraseMeteoUtente = "";
  document.getElementById("toggleMeteoBtn").style.display = "none";
  document.getElementById("meteoBox").style.display = "none";
  document.getElementById("meteoBox").innerHTML = "";

  // üîÅ Resetta mappa
  document.getElementById("toggleMappaBtn").style.display = "none";
  document.getElementById("map").style.display = "none";
  document.getElementById("nuovaDomandaBtn").style.display = "none";
  markers.forEach(m => m.setMap(null));
  markers = [];

  // üîÅ Resetta luoghi trovati
  document.getElementById("luoghi-trovati").style.display = "none";
  document.getElementById("luoghi-trovati").innerHTML = "";

  // üîÅ Rimuove dettagli attrazioni compatibili
  const dettagliAttrazioni = document.querySelectorAll("[id^='dettagli-attr-']");
  dettagliAttrazioni.forEach(el => el.remove());

  const pulsantiAttrazioni = Array.from(document.querySelectorAll("button"))
    .filter(b => b.textContent.startsWith("‚ÑπÔ∏è Dettagli:"));
  pulsantiAttrazioni.forEach(btn => btn.remove());
}

const cittaGiappone = {
tokyo: {
  nome: "Tokyo",
  lat: 35.6764,
  lon: 139.6500,
  quartieri: {
    akasaka: { lat: 35.6736, lon: 139.7360 },
    akihabara: { lat: 35.6984, lon: 139.7730 },
    asakusa: { lat: 35.7148, lon: 139.7967 },
    daikanyama: { lat: 35.6495, lon: 139.7032 },
    ebisu: { lat: 35.6467, lon: 139.7101 },
    ginza: { lat: 35.6717, lon: 139.7650 },
    harajuku: { lat: 35.6702, lon: 139.7020 },
    hibiya: { lat: 35.6731, lon: 139.7607 },
    ikebukuro: { lat: 35.7289, lon: 139.7100 },
    marunouchi_tokyo_station: { lat: 35.6812, lon: 139.7671 },
    meguro: { lat: 35.6339, lon: 139.7155 },
    minato_ku: { lat: 35.6581, lon: 139.7516 },
    nakameguro: { lat: 35.6419, lon: 139.6985 },
    nezu: { lat: 35.7205, lon: 139.7570 },
    nogizaka: { lat: 35.6657, lon: 139.7267 },
    odaiba: { lat: 35.6273, lon: 139.7758 },
    roppongi: { lat: 35.6605, lon: 139.7292 },
    sendagi: { lat: 35.7244, lon: 139.7526 },
    shibuya: { lat: 35.6595, lon: 139.7005 },
    shimbashi: { lat: 35.6663, lon: 139.7586 },
    shinjuku: { lat: 35.6938, lon: 139.7036 },
    sumida_oshiage: { lat: 35.7101, lon: 139.8107 },
    takadanobaba: { lat: 35.7126, lon: 139.7036 },
    ueno: { lat: 35.7148, lon: 139.7736 },
    yanaka: { lat: 35.7275, lon: 139.7654 },
    yaesu: { lat: 35.6779, lon: 139.7693 },
    yurakucho: { lat: 35.6755, lon: 139.7632 }
  }
},
  kyoto: { nome: "Kyoto", lat: 35.0116, lon: 135.7681 },
  osaka: { nome: "Osaka", lat: 34.6937, lon: 135.5023 },
  nara: { nome: "Nara", lat: 34.6851, lon: 135.8048 },
  yokohama: { nome: "Yokohama", lat: 35.4437, lon: 139.6380 },
  sapporo: { nome: "Sapporo", lat: 43.0667, lon: 141.3500 },
  fukuoka: { nome: "Fukuoka", lat: 33.5902, lon: 130.4017 },
  nagoya: { nome: "Nagoya", lat: 35.1815, lon: 136.9066 },
  hiroshima: { nome: "Hiroshima", lat: 34.3853, lon: 132.4553 },
  kobe: { nome: "Kobe", lat: 34.6901, lon: 135.1955 },
  kawasaki: { nome: "Kawasaki", lat: 35.5308, lon: 139.7036 },
  saitama: { nome: "Saitama", lat: 35.8617, lon: 139.6455 },
  sendai: { nome: "Sendai", lat: 38.2682, lon: 140.8694 },
  chiba: { nome: "Chiba", lat: 35.6074, lon: 140.1065 },
  kumamoto: { nome: "Kumamoto", lat: 32.7898, lon: 130.7417 },
  kagoshima: { nome: "Kagoshima", lat: 31.5966, lon: 130.5571 },
  nagasaki: { nome: "Nagasaki", lat: 32.7503, lon: 129.8777 },
  matsuyama: { nome: "Matsuyama", lat: 33.8392, lon: 132.7657 },
  oita: { nome: "Oita", lat: 33.2396, lon: 131.6093 },
  takamatsu: { nome: "Takamatsu", lat: 34.3401, lon: 134.0434 },
  kanazawa: { nome: "Kanazawa", lat: 36.5613, lon: 136.6562 },
  toyama: { nome: "Toyama", lat: 36.6953, lon: 137.2113 },
  niigata: { nome: "Niigata", lat: 37.9161, lon: 139.0364 },
  akita: { nome: "Akita", lat: 39.7200, lon: 140.1025 },
  aomori: { nome: "Aomori", lat: 40.8244, lon: 140.7400 },
  iwaki: { nome: "Iwaki", lat: 37.0500, lon: 140.8833 },
  hakodate: { nome: "Hakodate", lat: 41.7688, lon: 140.7288 },
  asahikawa: { nome: "Asahikawa", lat: 43.7706, lon: 142.3649 },
  takayama: { nome: "Takayama", lat: 36.1466, lon: 137.2510 },
  gifu: { nome: "Gifu", lat: 35.4233, lon: 136.7606 },
  nagano: { nome: "Nagano", lat: 36.6486, lon: 138.1947 },
  ueda: { nome: "Ueda", lat: 36.4023, lon: 138.2507 },
  shizuoka: { nome: "Shizuoka", lat: 34.9756, lon: 138.3828 },
  hamamatsu: { nome: "Hamamatsu", lat: 34.7100, lon: 137.7261 },
  hachinohe: { nome: "Hachinohe", lat: 40.5122, lon: 141.4880 },
  kure: { nome: "Kure", lat: 34.2331, lon: 132.5667 },
  tsu: { nome: "Tsu", lat: 34.7303, lon: 136.5086 },
  yokkaichi: { nome: "Yokkaichi", lat: 34.9653, lon: 136.6247 },
  beppu: { nome: "Beppu", lat: 33.2792, lon: 131.4970 },
  hikone: { nome: "Hikone", lat: 35.2764, lon: 136.2515 }
};

function trovaCittaNellaDomanda(domanda) {
  const testo = domanda.toLowerCase();
  for (const codiceCitta in cittaGiappone) {
    const citta = cittaGiappone[codiceCitta];
    if (testo.includes(codiceCitta)) {
      return { lat: citta.lat, lon: citta.lon };
    }

    if (typeof citta.quartieri === "object") {
      for (const q in citta.quartieri) {
        if (testo.includes(q)) {
          console.log("üéØ Quartiere riconosciuto:", q);
          return {
            lat: citta.quartieri[q].lat,
            lon: citta.quartieri[q].lon
          };
        }
      }
    }
  }
  return null;
}

  async function inviaDomanda() {
    const clienteId = document.getElementById("clienteId").value.trim();
    const domanda = document.getElementById("domanda").value.trim();

// üîÑ Nasconde visivamente meteo e mappa SEMPRE all'inizio
document.getElementById("toggleMeteoBtn").style.display = "none";
document.getElementById("meteoBox").style.display = "none";
document.getElementById("toggleMappaBtn").style.display = "none";
document.getElementById("map").style.display = "none";


// üîÅ RESET UI ‚Äî resetta meteo, mappa, luoghi trovati e attrazioni compatibili
document.getElementById("luoghi-trovati").style.display = "none";
document.getElementById("luoghi-trovati").innerHTML = "";

document.getElementById("meteoBox").style.display = "none";
document.getElementById("meteoBox").innerHTML = "";

document.getElementById("map").style.display = "none";

//   Rimuove dettagli attrazioni compatibili (div e pulsanti)
const dettagliAttrazioni = document.querySelectorAll("[id^='dettagli-attr-']");
dettagliAttrazioni.forEach(el => el.remove());

const pulsantiAttrazioni = Array.from(document.querySelectorAll("button"))
  .filter(b => b.textContent.startsWith("‚ÑπÔ∏è Dettagli:"));
pulsantiAttrazioni.forEach(btn => btn.remove());

const oraLocale = new Date().toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' });

const citt√†Richiesta = trovaCittaNellaDomanda(domanda);
const posizioneMeteo = citt√†Richiesta || posizioneUtente;

if (!window.fraseMeteoUtente) window.fraseMeteoUtente = "";

const giorniDifferenza = rilevaDataFutura(domanda);

if (giorniDifferenza !== null && giorniDifferenza > 7) {
  window.fraseMeteoUtente = "‚ö†Ô∏è Hai chiesto il meteo per una data futura. Al momento posso fornire previsioni solo entro i prossimi 7 giorni.";
}

if (citt√†Richiesta === null && domanda.toLowerCase().includes("meteo")) {
  window.fraseMeteoUtente = "‚ö†Ô∏è La funzione Meteo al momento non copre questa localit√†.";
}

if (posizioneMeteo && posizioneMeteo.lat && posizioneMeteo.lon) {
  await ottieniMeteo(posizioneMeteo.lat, posizioneMeteo.lon);
}

    const rispostaEl = document.getElementById("risposta");
    attivaGooglePlacesDaDomanda(domanda);
    attivaAttrazioniDaDomanda(domanda);
    rispostaEl.innerHTML = "";
    
if (window.fraseMeteoUtente && window.fraseMeteoUtente.trim() !== "") {
  document.getElementById("toggleMeteoBtn").style.display = "inline-block";
} else {
  document.getElementById("toggleMeteoBtn").style.display = "none";
  document.getElementById("meteoBox").style.display = "none";
}

    document.getElementById("spinner").style.display = "block";
    document.getElementById("nuovaDomandaBtn").style.display = "inline-block";

   try{

    document.getElementById("nuovaDomandaBtn").style.display = "none"; // nasconde il bottone in partenza

console.log("üì¶ METEO inviato:", window.fraseMeteoUtente);
console.log("üì¶ ORA locale:", oraLocale);
console.log("üì¶ Previsioni 7 giorni:", window.previsioniMeteoGiorni);

const fraseMeteoFinale = typeof window.fraseMeteoUtente === "string" ? window.fraseMeteoUtente : "";
const previsioniGiorniFinali = Array.isArray(window.previsioniMeteoGiorni) ? window.previsioniMeteoGiorni : [];

console.log("üõ∞Ô∏è METEO da inviare:", fraseMeteoFinale);
console.log("üõ∞Ô∏è PREVISIONI da inviare:", previsioniGiorniFinali);

// ‚¨áÔ∏è Questi valori vengono passati nel payload
const datiMeteoAttuale = fraseMeteoFinale;
const datiPrevisioni = previsioniGiorniFinali;

console.log("üì§ Sto per inviare:");
console.log("üõ∞Ô∏è METEO:", datiMeteoAttuale);
console.log("üõ∞Ô∏è PREVISIONI:", datiPrevisioni);

console.log("‚úÖ Tipo previsioniGiorniFinali:", typeof previsioniGiorniFinali);
console.log("‚úÖ √à array?:", Array.isArray(previsioniGiorniFinali));
console.log("‚úÖ Contenuto previsioni:", JSON.stringify(previsioniGiorniFinali));


    const response = await fetch("https://yuta-proxy-api.azurewebsites.net/api/proxy", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
       clienteId,
       domanda,
       meteo: fraseMeteoFinale,
       oraLocale,
       previsioniGiorni: previsioniGiorniFinali 
      })
    });

let json;
try {
  json = await response.json();
} catch (e) {
  rispostaEl.textContent = "‚ùå Il server ha restituito una risposta non valida.";
  document.getElementById("spinner").style.display = "none";
  console.error("Errore parse JSON:", e);
  return;
}
    if (json.risposta) {
//   Rimuove eventuali marker precedenti prima di creare i nuovi
markers.forEach(m => m.setMap(null));
markers = [];

      let testo = json.risposta
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/\n### (.*?)\n/g, "<h3>$1</h3>")
        .replace(/\n- (.*?)\n/g, "<ul><li>$1</li></ul>")
        .replace(/(?:\r\n|\r|\n)/g, "<br>");
      testo = testo.replace(/<\/ul><ul>/g, "");


let trovatoLuogo = false;
const luoghiTrovati = [];

for (const nome in luoghiConosciuti) {
  const regex = new RegExp(nome, "i");
  if (regex.test(json.risposta)) {
    trovatoLuogo = true;
    luoghiTrovati.push({ nome, ...luoghiConosciuti[nome] });
  }
}
      rispostaEl.innerHTML = "";
      let i = 0;
      let testoGrezzato = testo.replace(/<[^>]*>?/gm, ""); // Rimuove tag HTML solo per animazione

      function typeChar() {
        if (i < testoGrezzato.length) {
          rispostaEl.textContent += testoGrezzato.charAt(i);
          i++;
          setTimeout(typeChar, 20); // pi√π lento, circa 3x pi√π umano
        } else {
          rispostaEl.innerHTML = testo; // mostra versione HTML completa e stilizzata
         
// üéØ Mostra / Nascondi dettagli attrazioni compatibili
if (json.attrazioniDettagliate && json.attrazioniDettagliate.length > 0) {
  const contenitoreAttrazioni = document.createElement("div");
  contenitoreAttrazioni.style.marginTop = "20px";

  const titolo = document.createElement("strong");
  titolo.textContent = "üìç Vuoi vedere i dettagli delle attrazioni compatibili?";
  contenitoreAttrazioni.appendChild(titolo);
  contenitoreAttrazioni.appendChild(document.createElement("br"));

  json.attrazioniDettagliate.forEach((attr, index) => {
    const toggleId = `dettagli-attr-${index}`;

    const btn = document.createElement("button");
    btn.textContent = `‚ÑπÔ∏è Dettagli: ${attr.nome}`;
    btn.setAttribute("data-target", toggleId);
    btn.style.marginTop = "8px";
    btn.onclick = () => {
      const target = document.getElementById(toggleId);
      if (target.style.display === "none") {
        target.style.display = "block";
      } else {
        target.style.display = "none";
      }
    };

    const box = document.createElement("div");
    box.id = toggleId;
    box.style.display = "none";
    box.style.margin = "6px 0 16px";
    box.style.padding = "10px";
    box.style.border = "1px solid #ccc";
    box.style.borderRadius = "6px";
    box.style.background = "#f9f9f9";
    box.style.whiteSpace = "pre-line";

    const orari = Array.isArray(attr.orariSettimana) ? attr.orariSettimana.join("\n") : "n.d.";

const id = "attr-" + Math.random().toString(36).substr(2, 9); // ID univoco per ogni attrazione

box.innerHTML = `
  <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 6px;">${attr.nome}</div>
  <div><strong>Valutazione:</strong> ${attr.rating || "n.d."}</div>
  <div>üì¨ <strong>Indirizzo:</strong> ${attr.indirizzo || "n.d."}</div>
  <div>üïí <strong>Orari:</strong><br><pre style="margin: 4px 0 0; font-family: inherit;">${orari}</pre></div>
  <div>üí∞ <strong>Prezzo:</strong> ${attr.fasciaPrezzo || "¬• N.D."}</div>
  <div>üè∑Ô∏è <strong>Categoria:</strong> ${attr.tipoLuogo || "N.D."}</div>
  <div style="margin-top: 6px;">üîó <a href="${attr.urlGoogleMaps}" target="_blank">Apri su Google Maps</a></div>
  ${
    attr.urlFoto
      ? `<div style="margin-top: 6px;">
            <button onclick="document.getElementById('${id}').classList.toggle('hidden')">üì∏ Mostra/Nascondi Foto</button>
            <div id="${id}" class="hidden" style="margin-top: 8px;">
              <img src="${attr.urlFoto}" alt="Foto di ${attr.nome}" style="max-width: 100%; border-radius: 8px;">
            </div>
         </div>`
      : ""
  }
`;

    contenitoreAttrazioni.appendChild(btn);
    contenitoreAttrazioni.appendChild(box);
  });

  rispostaEl.appendChild(contenitoreAttrazioni);
}

          document.getElementById("spinner").style.display = "none";
          document.getElementById("nuovaDomandaBtn").style.display = "inline-block";

// ‚úÖ Mostra lista testuale dei luoghi trovati
if (trovatoLuogo && posizioneUtente) {
  const divLuoghi = document.getElementById("luoghi-trovati");
  const lista = luoghiTrovati.map(p => {
    const distanza = calcolaDistanzaKm(posizioneUtente, { lat: p.lat, lng: p.lng });
    return `‚Ä¢ ${p.nome} (a ${distanza} km da te)`;
  }).join("<br>");
  divLuoghi.innerHTML = `<strong>üìç Luoghi rilevati:</strong><br>${lista}`;
  divLuoghi.style.display = "block";

// ‚úÖ Mostra il pulsante "Mostra mappa"
      document.getElementById("toggleMappaBtn").style.display = "inline-block";
    } else {
      document.getElementById("luoghi-trovati").style.display = "none";
      document.getElementById("toggleMappaBtn").style.display = "none";
    }


  // ‚úÖ Mostra i luoghi trovati, se presenti
if (trovatoLuogo && map && posizioneUtente) {
  luoghiTrovati.forEach((p) => {
    const distanza = calcolaDistanzaKm(posizioneUtente, { lat: p.lat, lng: p.lng });

    const marker = new google.maps.Marker({
      position: { lat: p.lat, lng: p.lng },
      map: map,
      title: `${p.nome} (a ${distanza} km da te)`
    });

    marker.addListener("click", () => {
      window.open(p.link, "_blank");
    });
     markers.push(marker);
  });
document.getElementById("map").style.display = "none";

}
        }
      }
      typeChar();
     } else {
       rispostaEl.textContent = "‚ùå Nessuna risposta ricevuta.";
     } 
    } catch (err) {
      rispostaEl.textContent = "‚ùå Errore durante la richiesta.";
      console.error("Errore:", err);
    }
  }
</script>

<script>
let map;
let posizioneUtente = null;
let markers = []; // array per tenere traccia dei marker attivi

async function ottieniMeteo(lat, lon) {
  const apiKey = "7b514410b5b297ed1e5590442ff67eca"; // tua API key attiva
  const url = `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=minutely,alerts&appid=${apiKey}&lang=it&units=metric`;

  try {
    const response = await fetch(url);
    const json = await response.json();

window.previsioniMeteoGiorni = [];

if (json.daily && Array.isArray(json.daily)) {
  json.daily.slice(0, 7).forEach((giorno, index) => {
    const data = new Date(giorno.dt * 1000).toLocaleDateString("it-IT", { weekday: 'long', day: 'numeric', month: 'long' });
    const descrizione = giorno.weather[0].description;
    const tempMin = Math.round(giorno.temp.min);
    const tempMax = Math.round(giorno.temp.max);
    const pioggia = Math.round((giorno.pop || 0) * 100);

    const frase = `üìÖ ${data}: ${descrizione}, min ${tempMin}¬∞C / max ${tempMax}¬∞C, probabilit√† di pioggia ${pioggia}%.`;

    window.previsioniMeteoGiorni.push(frase);
  });
}

    const condizioneAttuale = json.current.weather[0].description;
    const temperatura = Math.round(json.current.temp);
    const pioveOra = condizioneAttuale.includes("pioggia");

    // Analizza se piover√† nelle prossime 8 ore
    const previsionePioggia = json.hourly.slice(0, 8).some(hour => {
      return hour.weather[0].description.includes("pioggia") || (hour.pop && hour.pop > 0.4);
    });

    let frase = `‚òÅÔ∏è Meteo attuale: ${condizioneAttuale}, ${temperatura}¬∞C.`;

    if (pioveOra || previsionePioggia) {
      frase += " √à prevista pioggia nelle prossime ore. Si consigliano attivit√† al chiuso, percorsi coperti e abbigliamento impermeabile.";
    } else {
      frase += " Nessuna pioggia prevista fino al tardo pomeriggio.";
    }

    window.fraseMeteoUtente = frase;
  } catch (err) {
    console.error("üåßÔ∏è Errore One Call API:", err);
    window.fraseMeteoUtente = "";
  }
}

const luoghiConosciuti = {
  "Senso-ji": { lat: 35.7148, lng: 139.7967, link: "https://www.google.com/maps?q=Senso-ji,Tokyo" },
  "Meiji Jingu": { lat: 35.6764, lng: 139.6993, link: "https://www.google.com/maps?q=Meiji+Jingu" },
  "Tokyo Tower": { lat: 35.6586, lng: 139.7454, link: "https://www.google.com/maps?q=Tokyo+Tower" },
  "Tokyo Skytree": { lat: 35.7101, lng: 139.8107, link: "https://www.google.com/maps?q=Tokyo+Skytree" },
  "Shibuya Crossing": { lat: 35.6595, lng: 139.7005, link: "https://www.google.com/maps?q=Shibuya+Crossing" },
  "Asakusa": { lat: 35.7148, lng: 139.7967, link: "https://www.google.com/maps?q=Asakusa,Tokyo" },
  "Ueno Zoo": { lat: 35.7166, lng: 139.7710, link: "https://www.google.com/maps?q=Ueno+Zoo" },
  "Ueno Park": { lat: 35.7148, lng: 139.7736, link: "https://www.google.com/maps?q=Ueno+Park" },
  "Akihabara": { lat: 35.6984, lng: 139.7730, link: "https://www.google.com/maps?q=Akihabara" },
  "Ginza": { lat: 35.6717, lng: 139.7650, link: "https://www.google.com/maps?q=Ginza" },
  "Tsukiji Market": { lat: 35.6655, lng: 139.7708, link: "https://www.google.com/maps?q=Tsukiji+Market" },
  "TeamLab Planets": { lat: 35.6199, lng: 139.7906, link: "https://www.google.com/maps?q=teamlab+planets+tokyo" },
  "Tokyo Disneyland": { lat: 35.6329, lng: 139.8804, link: "https://www.google.com/maps?q=Tokyo+Disneyland" },
  "Tokyo DisneySea": { lat: 35.6263, lng: 139.8889, link: "https://www.google.com/maps?q=Tokyo+DisneySea" },
  "Roppongi Hills": { lat: 35.6605, lng: 139.7292, link: "https://www.google.com/maps?q=Roppongi+Hills" },
  "Mori Art Museum": { lat: 35.6606, lng: 139.7294, link: "https://www.google.com/maps?q=Mori+Art+Museum" },
  "Odaiba": { lat: 35.6273, lng: 139.7758, link: "https://www.google.com/maps?q=Odaiba" },
  "DiverCity Tokyo": { lat: 35.6191, lng: 139.7761, link: "https://www.google.com/maps?q=DiverCity+Tokyo" },
  "Rainbow Bridge": { lat: 35.6457, lng: 139.7574, link: "https://www.google.com/maps?q=Rainbow+Bridge+Tokyo" },
  "Sumida Aquarium": { lat: 35.7102, lng: 139.8107, link: "https://www.google.com/maps?q=Sumida+Aquarium" },
  "Tokyo National Museum": { lat: 35.7188, lng: 139.7765, link: "https://www.google.com/maps?q=Tokyo+National+Museum" },
  "Nezu Museum": { lat: 35.6593, lng: 139.7221, link: "https://www.google.com/maps?q=Nezu+Museum" },
  "Yanaka Ginza": { lat: 35.7275, lng: 139.7654, link: "https://www.google.com/maps?q=Yanaka+Ginza" },
  "Imperial Palace": { lat: 35.6852, lng: 139.7528, link: "https://www.google.com/maps?q=Imperial+Palace+Tokyo" },
  "Kabukicho": { lat: 35.6959, lng: 139.7036, link: "https://www.google.com/maps?q=Kabukicho" },
  "Tokyo Dome": { lat: 35.7056, lng: 139.7519, link: "https://www.google.com/maps?q=Tokyo+Dome" },
  "Ikebukuro Sunshine City": { lat: 35.7295, lng: 139.7179, link: "https://www.google.com/maps?q=Sunshine+City+Ikebukuro" },
  "Shinjuku Gyoen": { lat: 35.6852, lng: 139.7100, link: "https://www.google.com/maps?q=Shinjuku+Gyoen" },
  "Tokyo Metropolitan Government Building": { lat: 35.6896, lng: 139.6921, link: "https://www.google.com/maps?q=Tokyo+Metropolitan+Government+Building" },
  "Hamarikyu Gardens": { lat: 35.6591, lng: 139.7625, link: "https://www.google.com/maps?q=Hamarikyu+Gardens" }
};

function calcolaDistanzaKm(p1, p2) {
  const R = 6371; // Raggio terrestre in km
  const dLat = (p2.lat - p1.lat) * Math.PI / 180;
  const dLon = (p2.lng - p1.lng) * Math.PI / 180;
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return (R * c).toFixed(2); // distanza in km con 2 decimali
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 13,
    center: { lat: 35.6895, lng: 139.6917 }, // Tokyo default
    mapTypeControl: false
  });

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        posizioneUtente = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        map.setCenter(posizioneUtente);

        new google.maps.Marker({
          position: posizioneUtente,
          map,
          title: "Tu sei qui",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#1c1c1c",
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: "#ffffff"
          }
        });

// document.getElementById("map").style.display = "block"; // sar√† gestita manualmente dal pulsante
      },
      (error) => {
        console.warn("‚ùå Geolocalizzazione non disponibile:", error);
      }
    );
  } else {
    console.warn("‚ùå Geolocalizzazione non supportata");
  }
}

function estraiKeywordLuogo(domanda) {
  const paroleChiave = ["ramen", "sushi", "vegano", "izakaya", "tempura", "okonomiyaki"];
  const testo = domanda.toLowerCase();
  return paroleChiave.find(p => testo.includes(p)) || ""; // se nulla, restituisce stringa vuota
}

function cercaLuoghiPerZona(domanda, tipo = "restaurant", keyword = "") {
  const posizione = trovaCittaNellaDomanda(domanda);

  if (!posizione || !map) {
    console.warn("‚ùå Nessuna citt√† trovata per la ricerca Places.");
    return;
  }

  const location = {
    lat: posizione.lat,
    lng: posizione.lon
  };

  const service = new google.maps.places.PlacesService(map);
  const request = {
    location: location,
    radius: 2000, // puoi regolare in base al tipo: 1500 per ristoranti, 3000 per attrazioni
    type: [tipo],
    keyword: keyword
  };

  service.nearbySearch(request, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
      console.log(`‚úÖ ${results.length} luoghi trovati a ${posizione.nome}`);
      mostraLuoghi(results, tipo);
    } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
      console.warn(`‚ö†Ô∏è Nessun luogo trovato a ${posizione.nome}`);
      document.getElementById("luoghi-trovati").innerHTML = `Nessun risultato trovato per questa zona.`;
    } else {
      console.error("‚ùå Errore Places API:", status);
    }
  });
}

function cercaLuoghiSmart(domanda, tipo = "restaurant", keyword = "") {
  if (!google.maps?.places || !map) {
    console.warn("‚ùå La libreria Google Places o la mappa non √® ancora pronta.");
    return;
  }

  const testo = domanda.toLowerCase();
  const posizioneRilevata = trovaCittaNellaDomanda(domanda);

  // ‚úÖ Regex avanzata per prossimit√† (include varianti e forme comuni)
  const regexProssimita = /\b(vicin[oa]?(?:\s*a?\s*me)?|nei\s*dintorni|qui\s*vicino|a\s*pochi\s*pass[iy]?|nelle\s+vicinanze|intorno\s*a\s*me|attorno\s*a\s*me|prossimit√†|zona\s*mia|da\s*qui|dove\s*sono|a\s*due\s*passi|immediate\s+vicinanze)\b/i;

  // ‚úÖ Parole simili come fallback in caso di digitazioni errate
  const paroleSimiliProssimita = [
    "vicin", "dintorn", "pochi pass", "intorn", "qui", "attorn", "vicinanz", "zona mia", "da qui", "dove son"
  ];

  const eVicinoAme = regexProssimita.test(testo) || paroleSimiliProssimita.some(p => testo.includes(p));

  // üìç Decidi quale posizione usare: citt√† menzionata o posizione utente
  const location = posizioneRilevata
    ? { lat: posizioneRilevata.lat, lng: posizioneRilevata.lon }
    : (eVicinoAme && posizioneUtente)
      ? posizioneUtente
      : null;

  if (!location || !map) {
    console.warn("‚ùå Nessuna posizione valida per la ricerca smart.");
    return;
  }

  const service = new google.maps.places.PlacesService(map);
  const request = {
    location: location,
    radius: 1500,
    type: [tipo],
    keyword: keyword
  };

  service.nearbySearch(request, (results, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      mostraLuoghi(results, tipo);
    } else {
      console.error("‚ùå Errore Places smart:", status);
    }
  });
}

function attivaGooglePlacesDaDomanda(domanda) {
  const testo = domanda.toLowerCase();

  const regexCibo = /\b(mangiare|dove\s+mangiare|ristorant[ei]|izakaya|un\s+posto\s+(dove\s+)?mangiare|mi\s+consigli\s+un\s+ristorante|posto\s+per\s+pranzare|cena\s+fuori|cibo\s+tipico|locale\s+dove\s+mangiare)\b/i;

  const paroleSimiliCibo = ["ristoran", "mangiar", "mangare", "izak", "pranzar", "cenar", "cib", "lokale", "magiare", "restorant"];

  const eDomandaCibo = regexCibo.test(testo) || paroleSimiliCibo.some(p => testo.includes(p));

  if (eDomandaCibo) {
    const keyword = estraiKeywordLuogo(domanda);
    cercaLuoghiSmart(domanda, "restaurant", keyword);
  }
}

function attivaAttrazioniDaDomanda(domanda) {
  const testo = domanda.toLowerCase();

  // ‚úÖ Regex principale
  const regexAttrazioni = /\b(cosa\s+(vedere|fare|visitare)|luoghi\s+di\s+interesse|attrazioni|posti\s+da\s+vedere|cosa\s+c'√®\s+da\s+vedere|esperienze\s+turistiche|tour|da\s+visitare|luogo\s+interessante|luoghi\s+turistici|posti\s+interessanti)\b/i;

  // ‚úÖ Fallback parole chiave fuzzy o generiche
  const paroleSimiliAttrazioni = [
    "veder", "visitar", "attrazion", "interess", "esperienz", "turist", "tour", "posti", "scoprire", "cosa da vedere", "luoghi carini", "da esplorare"
  ];

  const eDomandaAttrazioni = regexAttrazioni.test(testo) || paroleSimiliAttrazioni.some(p => testo.includes(p));

  if (eDomandaAttrazioni) {
    cercaLuoghiSmart(domanda, "tourist_attraction", "");
  }
}

function mostraLuoghi(results, tipo = "luogo") {
  const div = document.getElementById("luoghi-trovati");
  let contenuto = `<strong>üîç ${tipo === "restaurant" ? "Ristoranti consigliati" : "Luoghi da visitare"}:</strong><br><br>`;

  // Pulisce marker precedenti
  markers.forEach(m => m.setMap(null));
  markers = [];

results.slice(0, 4).forEach(place => {
  const posizione = place.geometry.location;
  const nome = place.name;
  const rating = place.rating ? `‚≠ê ${place.rating}` : "‚Äî";
  const indirizzo = place.vicinity || "Indirizzo non disponibile";
  const categoria = tipo === "restaurant" ? "Ristorante" : (
    place.types?.includes("museum") ? "Museo" : "Attrazione"
  );
  const aperto = place.opening_hours?.open_now !== undefined
    ? (place.opening_hours.open_now ? "üü¢ Aperto ora" : "üî¥ Chiuso ora")
    : "Orari non disponibili";

  const priceMap = {
    0: "¬• Gratuito",
    1: "¬• Economico",
    2: "¬•¬• Medio",
    3: "¬•¬•¬• Costoso",
    4: "¬•¬•¬•¬• Molto costoso"
  };
  const prezzo = priceMap[place.price_level] || "¬• N.D.";

  const categorie = place.types?.map(c => c.replace(/_/g, " ")).join(", ") || "n.d.";

  const foto = place.photos?.[0]?.photo_reference
    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photoreference=${place.photos[0].photo_reference}&key=${GOOGLE_KEY}`
    : null;

  const mapsUrl = place.place_id
    ? `https://maps.google.com/?cid=${place.place_id}`
    : "#";

  let distanzaTesto = "";
  if (posizioneUtente) {
    const distanzaKm = calcolaDistanzaKm(posizioneUtente, { lat: posizione.lat(), lng: posizione.lng() });
    distanzaTesto = `üß≠ ${distanzaKm} km da te<br>`;
  }

  contenuto += `
    <div style="margin-bottom: 16px;">
      <strong>${nome}</strong><br>
      ${categoria} ¬∑ ${rating} ¬∑ ${prezzo}<br>
      ${aperto}<br>
      ${distanzaTesto}${indirizzo}<br>
      <a href="${mapsUrl}" target="_blank">üìç Apri su Google Maps</a><br>
      <details style="margin-top: 6px;">
        <summary>üìã Info aggiuntive</summary>
        <div style="font-size: 0.95em; margin-top: 6px;">
          <strong>üìö Categorie:</strong> ${categorie}<br>
          ${foto ? `<img src="${foto}" alt="Foto ${nome}" style="margin-top:6px; width:100%; max-width:300px; border-radius:6px;">` : ""}
        </div>
      </details>
      <hr>
    </div>
  `;

    const marker = new google.maps.Marker({
      position: posizione,
      map: map,
      title: nome
    });

    marker.addListener("click", () => {
      window.open(`https://www.google.com/maps/search/?api=1&query_place_id=${place.place_id}`, "_blank");
    });

    markers.push(marker);
  });

  div.innerHTML = contenuto;
  div.style.display = "block";
  document.getElementById("map").style.display = "block";
  document.getElementById("toggleMappaBtn").textContent = "üîΩ Nascondi mappa";
}

</script>


<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const hamburger = document.querySelector(".hamburger");
    sidebar.style.width = "250px";
    hamburger.style.display = "none";

    // Chiude sidebar al click esterno
    document.addEventListener("click", function handleClickOutside(event) {
      if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
        sidebar.style.width = "0";
        hamburger.style.display = "block";
        document.removeEventListener("click", handleClickOutside);
      }
    });
  }
</script>

<script>
function toggleMeteo() {
  const meteoDiv = document.getElementById("meteoBox");
  const btn = document.getElementById("toggleMeteoBtn");

  // Aggiorna sempre il contenuto, indipendentemente dallo stato visibile
  meteoDiv.innerHTML = window.fraseMeteoUtente || "Nessuna informazione meteo disponibile.";

  if (meteoDiv.style.display === "none" || meteoDiv.style.display === "") {
    meteoDiv.style.display = "block";
    btn.textContent = "üîΩ Nascondi meteo";
  } else {
    meteoDiv.style.display = "none";
    btn.textContent = "üìç Mostra meteo";
  }
}

</script>

<script>
function toggleMappa() {
  const mapEl = document.getElementById("map");
  const btn = document.getElementById("toggleMappaBtn");

  if (mapEl.style.display === "none") {
    mapEl.style.display = "block";
    btn.textContent = "üîΩ Nascondi mappa";
  } else {
    mapEl.style.display = "none";
    btn.textContent = "üìç Mostra mappa";
  }
}
</script>


<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAG11Uloyz4kU6doqFu1WHkg3HhIWH8L8&libraries=places&callback=initMap"
  async defer>
</script>

<script>
async function analizzaImmagine() {
  const input = document.getElementById('imageInput');
  const tipo = document.getElementById('tipoAnalisi').value;
  const file = input.files[0];
  const output = document.getElementById('risultatoVision');
  const preview = document.getElementById('previewImg');
  const clienteId = document.getElementById("clienteId").value.trim();
  const domanda = document.getElementById("domanda").value.trim();

  output.innerHTML = `<div class="output-fadein" style="font-size: 1em; font-weight: 500; color: #555;">üîé <em>Analisi YUTA in corso...</em></div>`;
  preview.style.display = "none";

  if (!file) {
    output.innerHTML = "‚ö†Ô∏è Nessuna immagine selezionata.";
    return;
  }

  if (!clienteId) {
    alert("‚ö†Ô∏è Inserisci il codice cliente prima di caricare l'immagine.");
    output.innerHTML = "";
    return;
  }

  const reader = new FileReader();
  reader.onloadend = async () => {
    const base64 = reader.result.split(',')[1];
    preview.src = reader.result;
    preview.style.display = "block";
    document.getElementById("resetButton").classList.remove("hidden");

    try {
      const response = await fetch("https://yuta-proxy-api.azurewebsites.net/api/proxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tipoRichiesta: "analisiImmagine",
          immagineBase64: base64,
          tipoAnalisi: tipo,
          clienteId,
          domanda
        })
      });

      const json = await response.json();
      const res = json.visione?.responses?.[0] || {};
      let risultati = "";

      if (tipo === "LABEL_DETECTION" && res.labelAnnotations) {
        risultati = `<strong>üìã Etichette rilevate:</strong><br>` +
          res.labelAnnotations.map(l => `‚Ä¢ ${l.description} (${Math.round(l.score * 100)}%)`).join("<br>");
      } else if ((tipo === "TEXT_DETECTION" || tipo === "DOCUMENT_TEXT_DETECTION") && res.textAnnotations) {
        risultati = `<strong>üìù Testo rilevato:</strong><br><pre>${res.textAnnotations[0].description}</pre>`;
      } else if (tipo === "OBJECT_LOCALIZATION" && res.localizedObjectAnnotations) {
        risultati = `<strong>üì¶ Oggetti rilevati:</strong><br>` +
          res.localizedObjectAnnotations.map(o => `‚Ä¢ ${o.name} (${Math.round(o.score * 100)}%)`).join("<br>");
      } else if (tipo === "FACE_DETECTION" && res.faceAnnotations) {
        risultati = `<strong>üòä Volti rilevati:</strong><br>Volti trovati: ${res.faceAnnotations.length}`;
      } else if (tipo === "LANDMARK_DETECTION" && res.landmarkAnnotations) {
        risultati = `<strong>üèØ Luoghi famosi:</strong><br>` +
          res.landmarkAnnotations.map(l => `‚Ä¢ ${l.description} (${Math.round(l.score * 100)}%)`).join("<br>");
      } else if (tipo === "LOGO_DETECTION" && res.logoAnnotations) {
        risultati = `<strong>üíº Loghi:</strong><br>` +
          res.logoAnnotations.map(l => `‚Ä¢ ${l.description} (${Math.round(l.score * 100)}%)`).join("<br>");
} else if (json.visione?.predictions?.length > 0) {

  // ‚úÖ Azure Custom Vision
  const simboli = json.visione.predictions
    .filter(p => p.probability >= 0.6)
    .map(p => `‚Ä¢ ${p.tagName} (${Math.round(p.probability * 100)}%)`);
  risultati = `<strong>üéØ Simboli riconosciuti da YUTA Vision AI:</strong><br>${simboli.join("<br>")}`;
} else {
  risultati = "‚ö†Ô∏è Nessun risultato visivo rilevato.";
}

scriviTypingSimboli(risultati, "risultatoVision");

      // ‚úÖ Mostra sempre interpretazione GPT se disponibile
      if (json.interpretazione) {
let interpretazioneFormattata = json.interpretazione
  .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
  .replace(/\n### (.*?)\n/g, "<h3>$1</h3>")
  .replace(/\n- (.*?)\n/g, "<ul><li>$1</li></ul>")
  .replace(/(?:\r\n|\r|\n)/g, "<br>");
interpretazioneFormattata = interpretazioneFormattata.replace(/<\/ul><ul>/g, "");

document.getElementById("interpretazioneVision").innerHTML = `<div class="output-fadein"><strong>üß† Interpretazione YUTA:</strong><br>${interpretazioneFormattata}</div>`;
     
 }

    } catch (err) {
      console.error("‚ùå Errore proxy Azure o GAS:", err);
      output.innerHTML = "‚ö†Ô∏è Errore nell‚Äôanalisi dell‚Äôimmagine.";
    }
  };

  reader.readAsDataURL(file);
}
</script>

<script>
function resetAnalisiImmagine() {
  document.getElementById("imageInput").value = "";
  document.getElementById("previewImg").src = "";
  document.getElementById("previewImg").style.display = "none";
  document.getElementById("risultatoVision").innerHTML = "";
  document.getElementById("domanda").value = "";
  document.getElementById("resetButton").classList.add("hidden");
}

</script>

<script>
function scriviTypingSimboli(testoFinaleHTML, contenitoreID = "risultatoVision") {
  const testoGrezzato = testoFinaleHTML.replace(/<[^>]*>?/gm, ""); // Rimuove tag HTML
  let i = 0;
  const target = document.getElementById(contenitoreID);
  if (!target) return;

  target.innerHTML = `<div id="typingContainer" class="output-fadein" style="white-space: pre-wrap;"></div>`;
  const typingEl = document.getElementById("typingContainer");

  function typeChar() {
    if (i < testoGrezzato.length) {
      typingEl.textContent += testoGrezzato.charAt(i);
      i++;
      setTimeout(typeChar, 20);
    } else {
      typingEl.innerHTML = `
        <div class="output-fadein">${testoFinaleHTML}</div>
        <div class="output-fadein" style="font-size: 0.85em; color: #444; margin-top: 20px; text-align: right;">
          ‚úÖ Analisi effettuata con <strong>YUTA Vision AI</strong>
        </div>
      `;
    }
  }

  typeChar();
}

</script>


</body>
</html>

